name: RDP + Tailscale + RustDesk + (Optional) Chrome Remote Desktop (A)

on:
  workflow_dispatch:
    inputs:
      ts_tailnet: { description: "Tailscale tailnet", required: true }
      ts_api_key: { description: "Tailscale API key", required: true }
      ts_authkey: { description: "Tailscale Auth key", required: true }
      quick_test: { description: "Run 5-minute test", type: boolean, default: false }
      runtime_minutes: { description: "Runtime (max 360)", default: "355" }
      rdp_count: { description: "How many RDP instances", default: "1" }

permissions:
  contents: read
  actions: write

defaults:
  run:
    shell: pwsh

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 370

    env:
      RDP_USER: Bullettemporary
      RDP_PASS: Bullet@12345

    steps:
      - name: Install Tailscale
        run: |
          $msi = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i","`"$msi`"","/quiet","/norestart" -Wait

      - name: Start Tailscale
        run: |
          & "C:\Program Files\Tailscale\tailscale.exe" up `
            --authkey "${{ inputs.ts_authkey }}" `
            --hostname bullet `
            --accept-dns `
            --accept-routes

      - name: Enable RDP user + firewall
        run: |
          $u=$env:RDP_USER; $p=$env:RDP_PASS
          $sec = ConvertTo-SecureString $p -AsPlainText -Force
          New-LocalUser -Name $u -Password $sec -AccountNeverExpires -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group Administrators -Member $u -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u -ErrorAction SilentlyContinue
          Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" fDenyTSConnections 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: Install Python libs
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyautogui pynput pillow

      - name: Install RustDesk
        run: |
          $msi = "$env:TEMP\rustdesk.msi"
          Invoke-WebRequest https://github.com/rustdesk/rustdesk/releases/download/1.3.1/rustdesk-1.3.1-x86_64.msi -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i","`"$msi`"","/quiet","/norestart" -Wait

      - name: Open RustDesk ports
        run: |
          21115..21119 | ForEach-Object {
            netsh advfirewall firewall add rule name="RustDeskTCP$_" dir=in action=allow protocol=TCP localport=$_
          }
          netsh advfirewall firewall add rule name="RustDeskUDP21116" dir=in action=allow protocol=UDP localport=21116

      - name: Launch RustDesk (background) âœ… FIXED
        run: |
          $exe = "C:\Program Files\RustDesk\rustdesk.exe"
          if (-not (Test-Path $exe)) { exit 1 }
          Start-Process $exe -WindowStyle Hidden
          Start-Sleep 3
          Get-Process rustdesk

      - name: Keep alive
        run: |
          $mins = [int]"${{ inputs.runtime_minutes }}"
          $end = (Get-Date).AddMinutes($mins)
          while ((Get-Date) -lt $end) {
            Write-Host "Alive: $(Get-Date)"
            Start-Sleep 60
          }